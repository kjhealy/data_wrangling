## ----setup, include=FALSE------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(warning = FALSE, message = FALSE, 
                      fig.retina = 3, fig.align = "center")


## ----packages-data, include=FALSE----------------------------------------------------------------------------------------------------------
library(flipbookr)
library(cowplot)
ggplot2::theme_set(theme_cowplot())



## ----xaringanExtra, echo=FALSE-------------------------------------------------------------------------------------------------------------
xaringanExtra::use_xaringan_extra(c("tile_view"))
xaringanExtra::use_animate_css()
xaringanExtra::use_animate_all("fade")
xaringanExtra::use_clipboard()


## ----06-getting-data-in-1, message = TRUE--------------------------------------------------------------------------------------------------
library(here)      # manage file paths
library(socviz)    # data and some useful functions
library(tidyverse) # your friend and mine


## ------------------------------------------------------------------------------------------------------------------------------------------
# A little trick from the fs package: 
fs::dir_tree(here("data", "congress"))


## ------------------------------------------------------------------------------------------------------------------------------------------
read_csv(here("data", "congress", "17_95_congress.csv")) %>% 
  janitor::clean_names() %>% 
  head()


## ------------------------------------------------------------------------------------------------------------------------------------------
a <- c(1:10)

b <- 1

# You know what R will do here
a + b



## ------------------------------------------------------------------------------------------------------------------------------------------
add_b <- function(x) {
  b <- 1
  x + b # for any x
}


## ------------------------------------------------------------------------------------------------------------------------------------------
add_b(x = a)


## ------------------------------------------------------------------------------------------------------------------------------------------
add_b(x = 10)


## ------------------------------------------------------------------------------------------------------------------------------------------
add_b(x = c(1, 99, 1000))


## ------------------------------------------------------------------------------------------------------------------------------------------
library(gapminder)
gapminder %>% 
  summarize(n_distinct(country), 
            n_distinct(continent), 
            n_distinct(year), 
            n_distinct(lifeExp), 
            n_distinct(population))


## ------------------------------------------------------------------------------------------------------------------------------------------
library(gapminder)
gapminder %>% 
  summarize(n_distinct(country), 
            n_distinct(continent), 
            n_distinct(year), 
            n_distinct(lifeExp), 
            n_distinct(population))


## ------------------------------------------------------------------------------------------------------------------------------------------
gapminder %>% 
  summarize(across(everything(), n_distinct))


## ------------------------------------------------------------------------------------------------------------------------------------------
  map(gapminder, n_distinct)


## ------------------------------------------------------------------------------------------------------------------------------------------
gapminder %>% 
  map(n_distinct)


## ------------------------------------------------------------------------------------------------------------------------------------------
result <- gapminder %>% 
  map(n_distinct)

class(result)

result$continent

result[[2]]


## ------------------------------------------------------------------------------------------------------------------------------------------
gapminder %>% 
  map_int(n_distinct)


## ------------------------------------------------------------------------------------------------------------------------------------------
filenames <- dir(path = here("data", "congress"),
                 pattern = "*.csv",
                 full.names = TRUE)

filenames[1:15] # Just displaying the first 15, to save slide space



## ------------------------------------------------------------------------------------------------------------------------------------------
df <- filenames %>% 
  map_dfr(read_csv, .id = "congress") %>% #<<
  janitor::clean_names()

df


## ------------------------------------------------------------------------------------------------------------------------------------------
df %>% 
  select(born, death, start, end)


## ------------------------------------------------------------------------------------------------------------------------------------------
library(lubridate)

date_recodes <- c("born", "death", "start", "end")

df <- df %>% 
    mutate(across(any_of(date_recodes), mdy), 
           congress = as.double(congress) + 78)

df 



## ------------------------------------------------------------------------------------------------------------------------------------------
sessions <- tibble(congress = 79:116,
                   start_year = seq(1945, 2019, by = 2),
                   end_year = seq(1947, 2021, by = 2)) %>% 
  mutate(start_year = ymd(paste(start_year, "01", "03", sep = "-")), 
         end_year = ymd(paste(end_year, "01", "03", sep = "-")))


sessions



## ------------------------------------------------------------------------------------------------------------------------------------------
df %>% 
  select(congress, last, born)



## ------------------------------------------------------------------------------------------------------------------------------------------
sessions



## ---- message = TRUE-----------------------------------------------------------------------------------------------------------------------

df <- left_join(df, sessions) %>% 
  relocate(start_year:end_year, .after = congress)  

df 



## ------------------------------------------------------------------------------------------------------------------------------------------
library(naniar)
library(visdat)

organdata


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
gg_miss_var(organdata)


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
vis_dat(organdata)


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
miss_var_summary(organdata)


## ------------------------------------------------------------------------------------------------------------------------------------------
miss_case_summary(organdata)


## ------------------------------------------------------------------------------------------------------------------------------------------
organdata %>%
  select(consent_law, year, pubhealth, roads) %>%
  group_by(consent_law) %>%
  miss_var_summary()



## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
vis_miss(organdata)


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
library(congress)
gg_miss_upset(congress)


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
vis_miss(organdata, cluster = TRUE)


## ---- fig.height=6, fig.width=8------------------------------------------------------------------------------------------------------------
gg_miss_upset(organdata)


## ------------------------------------------------------------------------------------------------------------------------------------------
symptoms <- c("Anosmia", "Cough", "Fatigue", 
              "Diarrhea", "Breath", "Fever")
names(symptoms) <- symptoms
symptoms


## ------------------------------------------------------------------------------------------------------------------------------------------
# An Excel file!
dat <- readxl::read_xlsx(here("data", "symptoms.xlsx")) 
dat %>% print(n = nrow(dat))



## ------------------------------------------------------------------------------------------------------------------------------------------
subsets <- dat %>% 
  pull(combination)

## Check if each subset mentions each symptom or not
symptom_mat <- map_dfc(subsets, str_detect, symptoms) %>%
    data.frame() %>%
    t() %>% # transpose the result, this is a little gross, sorry
    as_tibble(.name_repair = "unique")

colnames(symptom_mat) <- symptoms
symptom_mat$count <- dat$count


## ------------------------------------------------------------------------------------------------------------------------------------------
symptom_mat %>% print(n = nrow(symptom_mat))


## ------------------------------------------------------------------------------------------------------------------------------------------
indvs <- symptom_mat %>%
    uncount(count) 

indvs



## ---- fig.width=16, fig.height=9, eval = FALSE---------------------------------------------------------------------------------------------
## # devtools::install_github("krassowski/complex-upset")
## 
## library(ComplexUpset)
## 
## upset(data = indvs, intersect = symptoms,
##       name="Symptom Groupings by Frequency. Total pool is 1,764 individuals.",
##       min_size = 0,
##       width_ratio = 0.125) +
##     labs(title = "Co-Occurence of COVID-19 Symptoms",
##          caption = "Data: covid.joinzoe.com/us | Graph: @kjhealy")
## 
## 


## ---- fig.width=12, fig.height=7, echo = FALSE---------------------------------------------------------------------------------------------
# devtools::install_github("krassowski/complex-upset")

library(ComplexUpset)

upset(data = indvs, intersect = symptoms, 
      name="Symptom Groupings by Frequency. Total pool is 1,764 individuals.", 
      min_size = 0,
      width_ratio = 0.125) +
    labs(title = "Co-Occurence of COVID-19 Symptoms",
         caption = "Data: covid.joinzoe.com/us | Graph: @kjhealy")




## ------------------------------------------------------------------------------------------------------------------------------------------
library(broom)
library(gapminder)


## ----07-.kjh-green[Iterating]-2------------------------------------------------------------------------------------------------------------
out <- lm(formula = lifeExp ~ gdpPercap + pop + continent,
          data = gapminder)


## ----07-.kjh-green[Iterating]-3------------------------------------------------------------------------------------------------------------
summary(out)


## ----07-.kjh-green[Iterating]-8------------------------------------------------------------------------------------------------------------
library(broom)


## ----07-.kjh-green[Iterating]-9------------------------------------------------------------------------------------------------------------
tidy(out)


## ----07-.kjh-green[Iterating]-11-----------------------------------------------------------------------------------------------------------
out_conf <- tidy(out, conf.int = TRUE)
out_conf 


## ------------------------------------------------------------------------------------------------------------------------------------------
out_conf %>%
    filter(term %nin% "(Intercept)") %>%
    mutate(nicelabs = prefix_strip(term, "continent")) %>%
    select(nicelabs, everything())


## ----07-.kjh-green[Iterating]-20-----------------------------------------------------------------------------------------------------------
eu77 <- gapminder %>% filter(continent == "Europe", year == 1977)
fit <- lm(lifeExp ~ log(gdpPercap), data = eu77)


## ----07-.kjh-green[Iterating]-21-----------------------------------------------------------------------------------------------------------

summary(fit)


## ----07-.kjh-green[Iterating]-22-----------------------------------------------------------------------------------------------------------

out_le <- gapminder %>%
    group_by(continent, year) %>%
    nest()

out_le



## ----07-.kjh-green[Iterating]-23-----------------------------------------------------------------------------------------------------------
out_le %>% filter(continent == "Europe" & year == 1977) %>% 
    unnest(cols = c(data))


## ----07-.kjh-green[Iterating]-24, echo = FALSE---------------------------------------------------------------------------------------------
old_digits <- getOption("digits")
options(digits = 3)


## ----07-.kjh-green[Iterating]-25-----------------------------------------------------------------------------------------------------------

fit_ols <- function(df) {
    lm(lifeExp ~ log(gdpPercap), data = df)
}

out_le <- gapminder %>%
    group_by(continent, year) %>%
    nest() %>% 
    mutate(model = map(data, fit_ols)) #<<


## ------------------------------------------------------------------------------------------------------------------------------------------
out_le


## ----07-.kjh-green[Iterating]-26-----------------------------------------------------------------------------------------------------------

fit_ols <- function(df) {
    lm(lifeExp ~ log(gdpPercap), data = df)
}

out_tidy <- gapminder %>%
    group_by(continent, year) %>%
    nest() %>% 
    mutate(model = map(data, fit_ols),
           tidied = map(model, tidy)) %>%
    unnest(cols = c(tidied)) %>%
    filter(term %nin% "(Intercept)" &
           continent %nin% "Oceania")


## ------------------------------------------------------------------------------------------------------------------------------------------
out_tidy


## ------------------------------------------------------------------------------------------------------------------------------------------
out_tidy %>% 
    ungroup() %>%
    sample_n(5)


## ----07-.kjh-green[Iterating]-27, echo = FALSE---------------------------------------------------------------------------------------------
options(digits = old_digits)

