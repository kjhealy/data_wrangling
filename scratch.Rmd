---
title: "Scratchfile"
author: "Kieran Healy"
date: "4/18/2021"
output: html_document
---

```{r}
library(tidyverse)
```


```{r}
as_tibble(mtcars) %>%
  nest_by(cyl) %>%
  mutate(model = list(lm(mpg ~ wt, data = data))) %>%
  summarize(broom::glance(model))


```

```{r 02-about-r-1}
## Inside code chunks, lines beginning with a # character are comments
## Comments are ignored by R

my_numbers <- c(1, 1, 2, 4, 1, 3, 1, 5) # Anything after a # character is ignored as well

```

```{r}

my_a <- my_b <- my_c <- my_d <- 1:10

rm(list = ls(pattern = "my*"))

```


So perhaps you're making a note like this. About some code:

```{r}
# r code goes here
mean(1:10)
```

More notes:

```{r}
library(socviz)
 
```

```{r}

gss_sm %>% 
  group_by(bigregion, religion) %>% #<<
  summarize(total = n()) %>% #<<
  mutate(freq = total / sum(total),
         pct = round(freq*100, digits = 1)) 

```


```{r}
gss_sm %>%
  group_by(race, sex, degree) %>%
  summarize(n = n(),
            mean_age = mean(age, na.rm = TRUE),
            mean_kids = mean(childs, na.rm = TRUE)) %>%
  mutate(pct = n/sum(n)*100) %>%
  filter(race !="Other") %>% 
  print(n = 23)
```



```{r}
library(survey)
library(srvyr)

gss_sm %>% 
  group_by(race, sex, degree) %>% 
  tally() %>% 
  mutate(prop = n/sum(n))


gss_lon

options(survey.lonely.psu = "adjust")
options(na.action="na.pass")

gss_wt <- subset(gss_lon, year > 1974) %>%
    mutate(stratvar = interaction(year, vstrat)) %>%
    as_survey_design(ids = vpsu,
                     strata = stratvar,
                     weights = wtssall,
                     nest = TRUE)

gss_wt %>% 
    filter(year == 2016) %>%
    group_by(race, sex, degree) %>%
    summarize(prop = survey_mean(na.rm = TRUE))


```


---
title: "Data Wrangling with R and the tidyverse"
description: |
  A Short Course using R and the Tidyverse suite of tools.
author:
- name: Kieran Healy
  url: https://kieranhealy.org
date: "`r Sys.Date()`"
output: distill::distill_article
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```




```{r}
library(stringr)
library(lubridate)

chat <- read_lines(here("data", "chat.txt"))

chat %>% 
  
chat_df <- tibble(  
  time = as_datetime(paste(today(), str_extract(chat, "\\d{2}:\\d{2}:\\d{2}")), tz = "EST"),
  from = str_replace(chat, "(\\d{2}:\\d{2}:\\d{2} From )(.+?)( to Everyone )(.+?$)", "\\2"),
  message = str_replace(chat, "(\\d{2}:\\d{2}:\\d{2} From )(.+?)( to Everyone )(.+?$)", "\\4"))

chat_df

chat_df %>% 
  group_by(from) %>% 
  tally() %>% 
  arrange(desc(n))

```


```{r}
qualtrics <- readxl::read_xlsx(here("data", "qualtrics.xlsx")) %>% 
  slice(-(1:2))
```





```{r}
library(tidyverse)
library(stringr)

## Tibble of respondents and goals
df <- tribble(
  ~respondent, ~goal_statement, 
  1, "Beer, hotdogs, good grades, sports",
  2, "GPA matters more than anything",
  3, "GPA, GRADE GRADE GRADE, work",
  4, "Live, laugh, love",
  5, "I drift alone on a sea of confusion",
  6, "Cake only",
  7, "I care nothing for grades"
)

df

## Academic search terms, nb lower case
acad_goals <- c("gpa", "grade")
fun_goals <- c("beer", "hotdogs", "cake")

# Construct "any of these terms" regex using paste()
acad_regex <- paste(acad_goals, collapse = "|") # The `|` means "or"
fun_regex <- paste(fun_goals, collapse = "|")

df %>% 
  mutate(acad_yn = str_detect(tolower(goal_statement), acad_regex), 
         fun_yn = str_detect(tolower(goal_statement), fun_regex), 
         acad_words_n = str_count(tolower(goal_statement), acad_regex), 
         fun_words_n = str_count(tolower(goal_statement), fun_regex)) 



```

# Qualtrics

```{r}

# install.packages("qualtRics")
library(tidyverse)
library(stringr)
library(qualtRics)
library(here)

df <- read_survey(here("data", "qualtrics-sample.csv"))  %>% 
  janitor::clean_names()

df

## The rename() lines below are just renaming the g variables
## consistently, so they all have the form g1_something_1,
## g1_something_2, g1_something_3 for however many gs and somethings
## and suffix numbers there are. The key to lengthening multiple values
## is to have a consistent naming scheme like this.

## The pivot operation takes all the "gX_something_X" variables and puts them in three
## new columns: g_number for g1, g2; g_name for the middle part, and n_measure
## for the number suffix. Then score gets whatever the value of the original 
## was, with e.g. row one g1_ext_1 = 1

df %>% 
  select(start_date, id_v2, gender, consent, 
         matches("^g")) %>%  
         rename_with(~ str_replace(.x, "(\\d{1}$)", "_\\1"), matches("^g")) %>% 
         rename_with(~ str_replace(.x, "([a-z]$)", "\\1_1"), matches("^g")) %>% 
    pivot_longer(cols = g1_ext_1:g2_support_3,
    names_to = c("g_number", "g_name", "n_measure"),
    names_sep = "_",
    values_to = "score") %>% 
  rename(gender = gender_1) # whoops, gender starts with a g
  


```



